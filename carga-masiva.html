<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga Masiva - DEBUG</title>
    <!-- Incluye PapaParse para analizar archivos CSV en el navegador -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js" defer></script>
</head>
<body>

    <h1>Prueba de Carga Masiva (DEBUG)</h1>
    <p>Por favor, arrastra un archivo CSV aquí o selecciona uno:</p>

    <div style="border: 2px dashed blue; padding: 20px; text-align: center; margin-bottom: 20px;" id="fileUploadArea">
        <input type="file" id="csvFile" accept=".csv">
        <label for="csvFile" style="cursor: pointer;">Arrastra CSV o haz clic para seleccionar</label>
        <div id="fileName"></div>
    </div>

    <button id="uploadButton" disabled>Cargar Registros</button>

    <div id="responseMessage" style="margin-top: 20px; color: green;"></div>

    <script>
        console.log("Script principal de la página iniciado."); // Debug: Script principal cargado

        // Inmediatamente después de cargar PapaParse, verifica si está definido
        if (typeof PapaParse !== 'undefined') {
            console.log("PapaParse está definido correctamente."); // Debug: PapaParse OK
            // Si PapaParse está definido, podemos adjuntar los listeners
            const csvFileInput = document.getElementById('csvFile');
            const fileNameDiv = document.getElementById('fileName');
            const uploadButton = document.getElementById('uploadButton');
            const responseMessageDiv = document.getElementById('responseMessage');
            const fileUploadArea = document.getElementById('fileUploadArea');

            // Asegurar que el botón esté habilitado para la prueba
            // uploadButton.disabled = false; 

            // Drag and Drop functionality
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault(); // Previene el comportamiento por defecto de dragover
                console.log("Evento dragover detectado."); // Debug
                fileUploadArea.style.borderColor = 'green'; // Feedback visual
            });

            fileUploadArea.addEventListener('dragleave', () => {
                console.log("Evento dragleave detectado."); // Debug
                fileUploadArea.style.borderColor = 'blue'; // Feedback visual
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); // Previene el comportamiento por defecto de drop
                console.log("Evento drop detectado."); // Debug
                fileUploadArea.style.borderColor = 'blue'; // Feedback visual
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    csvFileInput.files = files;
                    handleFileSelect(files[0]);
                }
            });

            // Handle file selection (cuando se hace clic en el input o label)
            csvFileInput.addEventListener('change', (event) => {
                console.log('Evento change del input de archivo disparado.'); // Debug
                const file = event.target.files[0];
                if (file) {
                    handleFileSelect(file);
                } else {
                    console.log('No se seleccionó ningún archivo.'); // Debug
                }
            });

            function handleFileSelect(file) {
                console.log('handleFileSelect - Archivo seleccionado:', file.name, file.size, file.type); // Debug: Archivo seleccionado
                fileNameDiv.innerText = `Archivo seleccionado: ${file.name}`;
                responseMessageDiv.style.display = 'block'; // Mostrar mensaje
                responseMessageDiv.style.color = 'orange';
                responseMessageDiv.innerText = 'Procesando CSV...';
                
                // Usar PapaParse para analizar el CSV
                PapaParse.parse(file, {
                    header: true, // Asume que la primera fila es el encabezado
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log('PapaParse Complete Callback - Resultados:', results); // Debug: Resultados de parseo
                        if (results.errors.length > 0) {
                            console.error('PapaParse Errores:', results.errors); // Debug: Errores de PapaParse
                            responseMessageDiv.style.color = 'red';
                            responseMessageDiv.innerText = `Error al procesar el CSV: ${results.errors[0].message}`;
                            uploadButton.disabled = true;
                        } else if (results.data.length === 0) {
                            responseMessageDiv.style.color = 'red';
                            responseMessageDiv.innerText = 'El archivo CSV está vacío o no contiene datos válidos.';
                            uploadButton.disabled = true;
                        } else {
                            parsedCsvData = results.data;
                            console.log('CSV parseado exitosamente. Registros:', parsedCsvData.length, parsedCsvData); // Debug: Datos parseados

                            responseMessageDiv.style.color = 'green';
                            responseMessageDiv.innerText = `Archivo "${file.name}" cargado y listo para procesar. Se encontraron ${parsedCsvData.length} registros.`;
                            uploadButton.disabled = false; // Habilitar el botón de carga
                        }
                    }
                });
            }

            // URL del Google Apps Script (esta sigue siendo necesaria para el envío real)
            const scriptURL = 'https://script.google.com/macros/s/AKfycbzUdIqjQFOF-lU7UYvGNPe7rhHWCdsR681cTjwVTDupcj29eIQIjXD16vhV8BEi8YHP/exec'; // Asegúrate de que esta sea tu URL correcta
            let parsedCsvData = [];

            // Handle upload button click
            uploadButton.addEventListener('click', async () => {
                console.log('Botón Cargar Registros clicado.'); // Debug
                if (parsedCsvData.length === 0) {
                    responseMessageDiv.style.color = 'red';
                    responseMessageDiv.innerText = 'No hay datos para cargar. Por favor, seleccione un archivo CSV primero.';
                    return;
                }

                responseMessageDiv.style.color = 'orange';
                responseMessageDiv.innerText = 'Enviando datos masivos... por favor, espera. Esto puede tardar unos segundos.';
                uploadButton.disabled = true; // Deshabilitar para evitar múltiples envíos

                try {
                    const response = await fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(parsedCsvData)
                    });

                    responseMessageDiv.style.color = 'green';
                    responseMessageDiv.innerText = `¡Carga masiva completada! Se registraron ${parsedCsvData.length} candidatos correctamente.`;
                    csvFileInput.value = ''; // Limpiar el input de archivo
                    fileNameDiv.innerText = '';
                    uploadButton.disabled = true;
                    parsedCsvData = [];
                } catch (error) {
                    responseMessageDiv.style.color = 'red';
                    responseMessageDiv.innerText = `Error al cargar datos masivos: ${error.message}. Por favor, revisa la consola para más detalles.`;
                    console.error('Error en la carga masiva:', error);
                    uploadButton.disabled = false;
                }
            });

        } else {
            console.error("ERROR: PapaParse NO está definido. La librería no se cargó correctamente."); // Debug: PapaParse NO OK
            document.getElementById('responseMessage').style.color = 'red';
            document.getElementById('responseMessage').innerText = 'Error crítico: La librería de procesamiento CSV no se pudo cargar. Intenta recargar la página o usar otro navegador.';
            document.getElementById('uploadButton').disabled = true;
        }

    </script>
</body>
</html>
